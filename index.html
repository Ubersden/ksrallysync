<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kingshot Rally Sync Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #0b1220;
      color: #e5e7eb;
    }

    h1 {
      margin-top: 0;
      font-size: 1.8rem;
      color: #facc15;
      text-align: center;
    }

    .card {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 20px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .description {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    th, td {
      padding: 0.4rem 0.5rem;
      text-align: left;
      font-size: 0.9rem;
    }

    th {
      border-bottom: 1px solid rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
    }

    tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.6);
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 0.3rem 0.4rem;
      border-radius: 0.4rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #020617;
      color: #e5e7eb;
      box-sizing: border-box;
    }

    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: #facc15;
      box-shadow: 0 0 0 1px #facc15;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
      align-items: center;
      justify-content: space-between;
    }

    .btn-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.4rem 0.9rem;
      font-size: 0.9rem;
      cursor: pointer;
      background: #16a34a;
      color: #f9fafb;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    button.secondary {
      background: #1f2937;
    }

    button.danger {
      background: #b91c1c;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    button:hover:not(:disabled) {
      filter: brightness(1.1);
    }

    .base-time {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .results {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(148, 163, 184, 0.4);
    }

    .results h2 {
      font-size: 1.1rem;
      margin: 0 0 0.4rem;
      color: #e5e7eb;
    }

    .warn {
      color: #f97316;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }

    .error {
      color: #fca5a5;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }

    .tag {
      display: inline-block;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: rgba(34, 197, 94, 0.15);
      color: #bbf7d0;
      border: 1px solid rgba(34, 197, 94, 0.6);
    }

    /* Live countdown section */
    .live {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 0.75rem;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    #liveStatus {
      margin-top: 0.75rem;
      font-size: 1.05rem;
      text-align: center;
      min-height: 3.2rem;
    }

    #liveStatus .next-name {
      font-weight: 700;
      color: #facc15;
    }

    #liveStatus .next-time {
      font-weight: 700;
      color: #22c55e;
    }

    #liveStatus .impact-time {
      font-weight: 600;
      color: #38bdf8;
    }

    .flash {
      animation: flash 1s infinite;
    }

    @keyframes flash {
      0%, 100% {
        background-color: transparent;
      }
      50% {
        background-color: rgba(250, 204, 21, 0.16);
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 0.75rem;
      }
      .card {
        padding: 1rem;
      }
      th, td {
        font-size: 0.8rem;
      }
      button {
        width: 100%;
        justify-content: center;
      }
      .btn-row {
        flex-direction: column;
        align-items: stretch;
      }
      .btn-group {
        width: 100%;
        flex-direction: column;
        align-items: flex-start;
      }
      .btn-group > * {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>Kingshot Rally Sync Tool</h1>
  <div class="card">
    <p class="description">
      Select a common <strong>rally time</strong> (join window) for all rallies, then enter each rally caller and their
      <strong>march time</strong> to the target.<br>
      Enter march times in <strong>seconds only</strong> (e.g. <code>37</code>).<br>
      The tool syncs hits using <strong>rally time + march time</strong> so all rallies land together.
    </p>

    <div class="btn-row">
      <div class="btn-group">
        <button type="button" id="addRowBtn">Ôºã Add Rally</button>
        <button type="button" class="secondary" id="clearBtn">Clear All</button>
      </div>
      <div class="btn-group">
        <label class="base-time">
          Rally time for all rallies:
          <select id="globalRallyTime">
            <option value="5">5 min</option>
            <option value="10">10 min</option>
            <option value="30">30 min</option>
            <option value="60">60 min</option>
          </select>
        </label>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width: 50%;">Caller Name</th>
          <th style="width: 30%;">March Time (s)</th>
          <th style="width: 20%;">Delay After Base (s)</th>
        </tr>
      </thead>
      <tbody id="rallyBody">
      </tbody>
    </table>

    <div class="btn-row">
      <button type="button" id="calcBtn">‚öîÔ∏è Calculate Rally Timing</button>
      <span class="base-time">
        Tip: Start fake rally to test march times from each rally lead to the target, then plug them in here.
      </span>
    </div>

    <div id="message"></div>

    <div class="results" id="results" style="display:none;">
      <h2>Rally Start Schedule <span class="tag">Synced Hit</span></h2>
      <div id="summary"></div>
      <table id="resultsTable">
        <thead>
          <tr>
            <th>Caller</th>
            <th>March (s)</th>
            <th>Delay After Base (s)</th>
          </tr>
        </thead>
        <tbody id="resultsBody">
        </tbody>
      </table>
    </div>

    <!-- Live countdown / animation section -->
    <div class="live" id="liveSection" style="display:none;">
      <div class="btn-row" style="margin-bottom:0.5rem;">
        <button type="button" id="startLiveBtn">‚ñ∂ Start First Rally</button>
        <span class="base-time">
          Click at the exact moment you create the <strong>base rally</strong> with the selected rally time.
        </span>
      </div>
      <div id="liveStatus"></div>
    </div>
  </div>

  <!-- Saint Uber footer with insignia -->
  <footer style="
    margin-top: 2rem;
    text-align: center;
    font-size: 0.85rem;
    color: #9ca3af;
    opacity: 0.9;
    padding-bottom: 2rem;
  ">
    <div style="margin-bottom:0.6rem;">
      <svg width="70" height="70" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="gold" x1="0" y1="0" x2="0" y2="200">
            <stop offset="0%" stop-color="#facc15"/>
            <stop offset="100%" stop-color="#b45309"/>
          </linearGradient>
        </defs>

        <!-- Crown -->
        <path d="M50 70 L70 40 L100 75 L130 40 L150 70 L140 120 H60 L50 70Z"
              fill="url(#gold)" stroke="#facc15" stroke-width="4"/>

        <!-- Wings -->
        <path d="M60 120 C20 130 20 170 60 180 L80 160 C40 160 40 135 80 135"
              fill="url(#gold)" stroke="#facc15" stroke-width="3"/>
        <path d="M140 120 C180 130 180 170 140 180 L120 160 C160 160 160 135 120 135"
              fill="url(#gold)" stroke="#facc15" stroke-width="3"/>

        <!-- Central Shield -->
        <circle cx="100" cy="130" r="25"
                fill="url(#gold)" stroke="#facc15" stroke-width="4"/>

        <!-- S symbol -->
        <text x="100" y="138"
              text-anchor="middle"
              font-size="28"
              font-weight="700"
              fill="#0b1220"
              style="font-family: 'Segoe UI', sans-serif;">
          S
        </text>
      </svg>
    </div>

    ‚ú¶ Tool concept by <span style="color:#facc15; font-weight:600;">Saint Uber</span><br>
    <span style="font-size:0.75rem; opacity:0.8;"> Rally Sync Innovator ‚Äì Kingshot</span>
  </footer>

  <script>
    const rallyBody = document.getElementById('rallyBody');
    const addRowBtn = document.getElementById('addRowBtn');
    const clearBtn = document.getElementById('clearBtn');
    const calcBtn = document.getElementById('calcBtn');
    const messageDiv = document.getElementById('message');
    const resultsDiv = document.getElementById('results');
    const resultsBody = document.getElementById('resultsBody');
    const summaryDiv = document.getElementById('summary');
    const globalRallyTimeSelect = document.getElementById('globalRallyTime');

    const liveSection = document.getElementById('liveSection');
    const liveStatus = document.getElementById('liveStatus');
    const startLiveBtn = document.getElementById('startLiveBtn');

    // Live countdown
    let schedule = [];          // [{ name, delay, rowEl, launched }]
    let liveInterval = null;
    let liveStartTime = null;

    // Rally timing globals
    let globalRallySeconds = 5 * 60;
    let globalMaxMarch = 0;
    let globalTotalDuration = 0;  // rally time + max march
    let lastImpactBeepSecond = null;

    // Audio beep
    let audioCtx = null;

    function initAudio() {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (AC) audioCtx = new AC();
      }
      if (audioCtx && audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    }

    function beep() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 880;
      gain.gain.value = 0.12;
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      osc.start(now);
      osc.stop(now + 0.15);
    }

    function addRow(name = '', marchTime = '') {
      const tr = document.createElement('tr');

      // Caller name
      const nameTd = document.createElement('td');
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.placeholder = 'Name';
      if (name) nameInput.value = name;
      nameInput.classList.add('caller-name');
      nameTd.appendChild(nameInput);

      // March time in seconds
      const timeTd = document.createElement('td');
      const timeInput = document.createElement('input');
      timeInput.type = 'text';
      timeInput.placeholder = 'seconds (e.g. 37)';
      if (marchTime) timeInput.value = marchTime;
      timeInput.classList.add('march-time');
      timeTd.appendChild(timeInput);

      // Delay column will be filled after calculation (read-only text)
      const delayTd = document.createElement('td');
      delayTd.textContent = '-';

      tr.appendChild(nameTd);
      tr.appendChild(timeTd);
      tr.appendChild(delayTd);

      rallyBody.appendChild(tr);
    }

    // Parse seconds-only
    function parseTime(str) {
      if (!str) return NaN;
      str = str.trim();
      const v = parseFloat(str);
      return isNaN(v) || v <= 0 ? NaN : v;
    }

    // Format seconds as mm:ss for summary readability
    function formatTime(sec) {
      if (!isFinite(sec)) return '';
      sec = Math.round(sec);
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return m + ':' + String(s).padStart(2, '0');
    }

    function resetLive() {
      if (liveInterval) {
        clearInterval(liveInterval);
        liveInterval = null;
      }
      liveStartTime = null;
      liveStatus.textContent = '';
      liveStatus.classList.remove('flash');
      startLiveBtn.disabled = false;
      lastImpactBeepSecond = null;
      schedule.forEach(item => {
        item.rowEl.style.outline = 'none';
      });
    }

    function calculate() {
      messageDiv.innerHTML = '';
      messageDiv.className = '';
      resultsDiv.style.display = 'none';
      resultsBody.innerHTML = '';
      summaryDiv.innerHTML = '';
      liveSection.style.display = 'none';
      resetLive();
      schedule = [];

      const rallyMinutes = parseInt(globalRallyTimeSelect.value, 10) || 5;
      globalRallySeconds = rallyMinutes * 60;

      const rows = Array.from(rallyBody.querySelectorAll('tr'));
      const entries = [];

      for (const row of rows) {
        const nameInput = row.querySelector('.caller-name');
        const marchInput = row.querySelector('.march-time');

        if (!nameInput || !marchInput) continue;

        const name = nameInput.value.trim();
        const timeStr = marchInput.value.trim();

        if (!name && !timeStr) {
          continue; // ignore empty row
        }

        if (!timeStr) {
          messageDiv.textContent = 'Each rally needs a march time in seconds.';
          messageDiv.className = 'error';
          return;
        }

        const secs = parseTime(timeStr);
        if (isNaN(secs)) {
          messageDiv.textContent = `Invalid march time "${timeStr}". Enter seconds only (e.g. 37).`;
          messageDiv.className = 'error';
          return;
        }

        entries.push({
          name: name || 'Unnamed',
          marchSeconds: secs,
          rowEl: row
        });
      }

      if (entries.length < 2) {
        messageDiv.textContent = 'Add at least two rallies to sync.';
        messageDiv.className = 'warn';
        return;
      }

      globalMaxMarch = Math.max(...entries.map(e => e.marchSeconds));
      globalTotalDuration = globalRallySeconds + globalMaxMarch;

      const baseEntries = entries.filter(e => e.marchSeconds === globalMaxMarch);
      let baseLabel;
      if (baseEntries.length === 1) {
        baseLabel = `Base (slowest) rally is <strong>${baseEntries[0].name}</strong> with march <strong>${globalMaxMarch}s (${formatTime(globalMaxMarch)})</strong>.`;
      } else {
        const names = baseEntries.map(e => e.name).join(', ');
        baseLabel = `Multiple base rallies share the slowest march time <strong>${globalMaxMarch}s (${formatTime(globalMaxMarch)})</strong>: <strong>${names}</strong>. Choose any one as your base.`;
      }

      summaryDiv.innerHTML = `
        <p class="description">
          ${baseLabel}<br>
          Common rally time: <strong>${rallyMinutes} min (${globalRallySeconds}s, ${formatTime(globalRallySeconds)})</strong>.<br>
          From base rally creation (t = 0) to impact: <strong>${globalTotalDuration}s (${formatTime(globalTotalDuration)})</strong>.<br>
          Click "Start First Rally" when you create the base rally in-game (t = 0). Launch all other rallies after the listed delays.
        </p>
      `;

      // Build results table & schedule (seconds-only in table)
      entries.forEach(e => {
        const delay = Math.max(0, globalMaxMarch - e.marchSeconds);
      
        // üü¢ Update delay cell in the TOP table (input rows)
        const originalDelayCell = e.rowEl.children[2]; // 3rd <td> in the input row
        if (originalDelayCell) {
          originalDelayCell.textContent = `${delay}s`;
        }
      
        // Also fill the RESULTS table below
        const tr = document.createElement('tr');
      
        const nameTd = document.createElement('td');
        nameTd.textContent = e.name;
      
        const marchTd = document.createElement('td');
        marchTd.textContent = `${e.marchSeconds}s`;
      
        const delayTd = document.createElement('td');
        delayTd.textContent = `${delay}s`;
      
        tr.appendChild(nameTd);
        tr.appendChild(marchTd);
        tr.appendChild(delayTd);
        resultsBody.appendChild(tr);
      
        schedule.push({
          name: e.name,
          delay,
          rowEl: tr,
          launched: false
        });
      });


      // Sort schedule by delay so we know call order
      schedule.sort((a, b) => a.delay - b.delay);

      resultsDiv.style.display = 'block';
      liveSection.style.display = 'block';
      liveStatus.textContent = 'Ready. Click "Start First Rally" when you create the base rally.';
      startLiveBtn.disabled = false;
    }

    function startLiveCountdown() {
      if (!schedule.length) return;

      resetLive();
      initAudio();
      liveStartTime = Date.now();
      startLiveBtn.disabled = true;
      liveStatus.classList.add('flash');

      liveInterval = setInterval(() => {
        const elapsed = (Date.now() - liveStartTime) / 1000;
        const impactRemaining = globalTotalDuration - elapsed;

        // Beep when each rally's delay is reached
        for (const item of schedule) {
          if (!item.launched && elapsed >= item.delay) {
            item.launched = true;
            beep();
          }
        }

        // Impact reached
        if (impactRemaining <= 0) {
          liveStatus.classList.remove('flash');
          liveStatus.innerHTML = 'üéØ Target should be hit now. All synced rallies have landed.';
          schedule.forEach(item => {
            item.rowEl.style.outline = 'none';
          });
          clearInterval(liveInterval);
          liveInterval = null;
          return;
        }

        // Last 10 seconds countdown beeps
        const impactSecInt = Math.ceil(impactRemaining);
        if (impactSecInt <= 10 && impactSecInt > 0 && impactSecInt !== lastImpactBeepSecond) {
          beep();
          lastImpactBeepSecond = impactSecInt;
        }

        // Find next rally to launch
        let next = null;
        for (const item of schedule) {
          if (!item.launched && item.delay > elapsed) {
            if (!next || item.delay < next.delay) {
              next = item;
            }
          }
        }

        if (next) {
          const remaining = next.delay - elapsed;
          schedule.forEach(item => item.rowEl.style.outline = 'none');
          next.rowEl.style.outline = '2px solid rgba(250, 204, 21, 0.9)';

          liveStatus.innerHTML = `
            Next rally: <span class="next-name">${next.name}</span>
            in <span class="next-time">${remaining.toFixed(1)}s</span><br>
            Time until impact: <span class="impact-time">${impactRemaining.toFixed(1)}s</span>
          `;
        } else {
          schedule.forEach(item => item.rowEl.style.outline = 'none');
          liveStatus.innerHTML = `
            ‚úÖ All rallies created.<br>
            Time until impact: <span class="impact-time">${impactRemaining.toFixed(1)}s</span>
          `;
        }
      }, 100);
    }

    // Event hooks
    addRowBtn.addEventListener('click', () => addRow());
    clearBtn.addEventListener('click', () => {
      rallyBody.innerHTML = '';
      resultsDiv.style.display = 'none';
      summaryDiv.innerHTML = '';
      liveSection.style.display = 'none';
      messageDiv.textContent = '';
      messageDiv.className = '';
      resetLive();
      addRow();
      addRow();
      addRow();
    });
    calcBtn.addEventListener('click', calculate);
    startLiveBtn.addEventListener('click', startLiveCountdown);

    // Default empty rows on load
    addRow();
    addRow();
    addRow();
  </script>
</body>
</html>
