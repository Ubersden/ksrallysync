<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kingshot Rally Sync Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #0b1220;
      color: #e5e7eb;
    }

    h1 {
      margin-top: 0;
      font-size: 1.8rem;
      color: #facc15;
      text-align: center;
    }

    .card {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 20px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .description {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    th, td {
      padding: 0.4rem 0.5rem;
      text-align: left;
      font-size: 0.9rem;
    }

    th {
      border-bottom: 1px solid rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
    }

    tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.6);
    }

    input[type="text"],
    input[type="time"],
    select {
      width: 100%;
      padding: 0.3rem 0.4rem;
      border-radius: 0.4rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #020617;
      color: #e5e7eb;
      box-sizing: border-box;
    }

    input[type="text"]:focus,
    input[type="time"]:focus,
    select:focus {
      outline: none;
      border-color: #facc15;
      box-shadow: 0 0 0 1px #facc15;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
      align-items: center;
      justify-content: space-between;
    }

    .btn-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.4rem 0.9rem;
      font-size: 0.9rem;
      cursor: pointer;
      background: #16a34a;
      color: #f9fafb;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    button.secondary {
      background: #1f2937;
    }

    button.danger {
      background: #b91c1c;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    button:hover:not(:disabled) {
      filter: brightness(1.1);
    }

    .base-time {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .results {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(148, 163, 184, 0.4);
    }

    .results h2 {
      font-size: 1.1rem;
      margin: 0 0 0.4rem;
      color: #e5e7eb;
    }

    .warn {
      color: #f97316;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }

    .error {
      color: #fca5a5;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }

    .tag {
      display: inline-block;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: rgba(34, 197, 94, 0.15);
      color: #bbf7d0;
      border: 1px solid rgba(34, 197, 94, 0.6);
    }

    /* Live countdown section */
    .live {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 0.75rem;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    #liveStatus {
      margin-top: 0.75rem;
      font-size: 1.05rem;
      text-align: center;
      min-height: 3.2rem;
    }

    #liveStatus .next-name {
      font-weight: 700;
      color: #facc15;
    }

    #liveStatus .next-time {
      font-weight: 700;
      color: #22c55e;
    }

    #liveStatus .impact-time {
      font-weight: 600;
      color: #38bdf8;
    }

    .flash {
      animation: flash 1s infinite;
    }

    @keyframes flash {
      0%, 100% {
        background-color: transparent;
      }
      50% {
        background-color: rgba(250, 204, 21, 0.16);
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 0.75rem;
      }
      .card {
        padding: 1rem;
      }
      th, td {
        font-size: 0.8rem;
      }
      button {
        width: 100%;
        justify-content: center;
      }
      .btn-row {
        flex-direction: column;
        align-items: stretch;
      }
      .btn-group {
        width: 100%;
        flex-direction: column;
        align-items: flex-start;
      }
      .btn-group > * {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>Kingshot Rally Sync Tool</h1>
  <div class="card">
    <p class="description">
      Select a common <strong>rally time</strong> (join window) for all rallies, then enter each rally caller and their
      <strong>march time</strong> to the target.<br>
      Enter march times in <strong>seconds only</strong> (e.g. <code>37</code>).<br>
      The tool syncs hits using <strong>rally time + march time</strong> so all rallies land together.
    </p>

    <div class="btn-row">
      <div class="btn-group">
        <button type="button" id="addRowBtn">Ôºã Add Rally</button>
        <button type="button" class="secondary" id="clearBtn">Clear All</button>
      </div>
      <div class="btn-group">
        <label class="base-time">
          Rally time for all rallies:
          <select id="globalRallyTime">
            <option value="5">5 min</option>
            <option value="10">10 min</option>
            <option value="30">30 min</option>
            <option value="60">60 min</option>
          </select>
        </label>
        <label class="base-time">
          Base rally creation time (optional):
          <input type="time" id="baseStartTime">
        </label>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width: 50%;">Caller Name</th>
          <th style="width: 30%;">March Time (seconds)</th>
          <th style="width: 20%;">Remove</th>
        </tr>
      </thead>
      <tbody id="rallyBody">
      </tbody>
    </table>

    <div class="btn-row">
      <button type="button" id="calcBtn">‚öîÔ∏è Calculate Rally Timing</button>
      <span class="base-time">
        Tip: Start fake rally to test march times from each rally lead to the target, then plug them in here.
      </span>
    </div>

    <div id="message"></div>

    <div class="results" id="results" style="display:none;">
      <h2>Rally Start Schedule <span class="tag">Synced Hit</span></h2>
      <div id="summary"></div>
      <table id="resultsTable">
        <thead>
          <tr>
            <th>Caller</th>
            <th>March Time</th>
            <th>Delay After Base (rally create)</th>
            <th>Rally Creation Time (if base set)</th>
          </tr>
        </thead>
        <tbody id="resultsBody">
        </tbody>
      </table>
    </div>

    <!-- Live countdown / animation section -->
    <div class="live" id="liveSection" style="display:none;">
      <div class="btn-row" style="margin-bottom:0.5rem;">
        <button type="button" id="startLiveBtn">‚ñ∂ Start First Rally</button>
        <span class="base-time">
          Click at the exact moment you create the <strong>base rally</strong> with the selected rally time.
        </span>
      </div>
      <div id="liveStatus"></div>
    </div>
  </div>

  <!-- Saint Uber footer with insignia -->
  <footer style="
    margin-top: 2rem;
    text-align: center;
    font-size: 0.85rem;
    color: #9ca3af;
    opacity: 0.9;
    padding-bottom: 2rem;
  ">
    <div style="margin-bottom:0.6rem;">
      <svg width="70" height="70" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="gold" x1="0" y1="0" x2="0" y2="200">
            <stop offset="0%" stop-color="#facc15"/>
            <stop offset="100%" stop-color="#b45309"/>
          </linearGradient>
        </defs>

        <!-- Crown -->
        <path d="M50 70 L70 40 L100 75 L130 40 L150 70 L140 120 H60 L50 70Z"
              fill="url(#gold)" stroke="#facc15" stroke-width="4"/>

        <!-- Wings -->
        <path d="M60 120 C20 130 20 170 60 180 L80 160 C40 160 40 135 80 135"
              fill="url(#gold)" stroke="#facc15" stroke-width="3"/>
        <path d="M140 120 C180 130 180 170 140 180 L120 160 C160 160 160 135 120 135"
              fill="url(#gold)" stroke="#facc15" stroke-width="3"/>

        <!-- Central Shield -->
        <circle cx="100" cy="130" r="25"
                fill="url(#gold)" stroke="#facc15" stroke-width="4"/>

        <!-- S symbol -->
        <text x="100" y="138"
              text-anchor="middle"
              font-size="28"
              font-weight="700"
              fill="#0b1220"
              style="font-family: 'Segoe UI', sans-serif;">
          S
        </text>
      </svg>
    </div>

    ‚ú¶ Tool concept by <span style="color:#facc15; font-weight:600;">Saint Uber</span><br>
    <span style="font-size:0.75rem; opacity:0.8;"> Rally Sync Innovator ‚Äì Kingshot</span>
  </footer>

  <script>
    const rallyBody = document.getElementById('rallyBody');
    const addRowBtn = document.getElementById('addRowBtn');
    const clearBtn = document.getElementById('clearBtn');
    const calcBtn = document.getElementById('calcBtn');
    const messageDiv = document.getElementById('message');
    const resultsDiv = document.getElementById('results');
    const resultsBody = document.getElementById('resultsBody');
    const summaryDiv = document.getElementById('summary');
    const baseStartInput = document.getElementById('baseStartTime');
    const globalRallyTimeSelect = document.getElementById('globalRallyTime');

    const liveSection = document.getElementById('liveSection');
    const liveStatus = document.getElementById('liveStatus');
    const startLiveBtn = document.getElementById('startLiveBtn');

    // For the live countdown
    let schedule = [];        // [{ name, delay, rowEl, launched }]
    let liveInterval = null;
    let liveStartTime = null;

    // Global timing
    let globalRallySeconds = 5 * 60;
    let globalMaxMarch = 0;
    let globalTotalDuration = 0; // rally + max march
    let lastImpactBeepSecond = null;

    // Audio (beep) setup
    let audioCtx = null;

    function initAudio() {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (AC) {
          audioCtx = new AC();
        }
      }
      if (audioCtx && audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    }

    function beep() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 880; // Hz
      gain.gain.value = 0.12;

      osc.connect(gain);
      gain.connect(audioCtx.destination);

      const now = audioCtx.currentTime;
      osc.start(now);
      osc.stop(now + 0.15); // short beep
    }

    function addRow(name = '', marchTime = '') {
      const tr = document.createElement('tr');

      // Caller name
      const nameTd = document.createElement('td');
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.placeholder = 'Name';
      nameInput.value = name;
      nameInput.classList.add('caller-name');
      nameTd.appendChild(nameInput);

      // March time (seconds)
      const timeTd = document.createElement('td');
      const timeInput = document.createElement('input');
      timeInput.type = 'text';
      timeInput.placeholder = 'seconds (e.g. 37)';
      timeInput.value = marchTime;
      timeInput.classList.add('march-time');
      timeTd.appendChild(timeInput);

      // Remove button
      const removeTd = document.createElement('td');
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.textContent = 'üóë Remove';
      removeBtn.classList.add('danger');
      removeBtn.addEventListener('click', () => {
        rallyBody.removeChild(tr);
      });
      removeTd.appendChild(removeBtn);

      tr.appendChild(nameTd);
      tr.appendChild(timeTd);
      tr.appendChild(removeTd);

      rallyBody.appendChild(tr);
    }

    // Parse seconds-only time
    function parseTime(str) {
      if (!str) return NaN;
      str = str.trim();
      if (!str) return NaN;

      const v = parseFloat(str);
      if (isNaN(v) || v <= 0) return NaN;

      return v;
    }

    // Format seconds as mm:ss
    function formatTime(sec) {
      if (!isFinite(sec)) return '';
      sec = Math.round(sec);
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return m + ':' + String(s).padStart(2, '0');
    }

    function parseBaseTimeToDate(timeStr) {
      if (!timeStr) return null;
      const [h, m] = timeStr.split(':').map(Number);
      if (isNaN(h) || isNaN(m)) return null;
      const now = new Date();
      now.setHours(h, m, 0, 0);
      return now;
    }

    function formatClockTime(date) {
      const h = String(date.getHours()).padStart(2, '0');
      const m = String(date.getMinutes()).padStart(2, '0');
      const s = String(date.getSeconds()).padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    function resetLive() {
      if (liveInterval) {
        clearInterval(liveInterval);
        liveInterval = null;
      }
      liveStartTime = null;
      liveStatus.textContent = '';
      liveStatus.classList.remove('flash');
      startLiveBtn.disabled = false;
      lastImpactBeepSecond = null;
      schedule.forEach(item => {
        item.rowEl.style.outline = 'none';
      });
    }

    function calculate() {
      messageDiv.innerHTML = '';
      messageDiv.className = '';
      resultsDiv.style.display = 'none';
      resultsBody.innerHTML = '';
      summaryDiv.innerHTML = '';
      liveSection.style.display = 'none';
      resetLive();
      schedule = [];

      // Global rally time
      const rallyMinutes = parseInt(globalRallyTimeSelect.value, 10) || 5;
      globalRallySeconds = rallyMinutes * 60;

      const rows = Array.from(rallyBody.querySelectorAll('tr'));
      const entries = [];

      for (const row of rows) {
        const nameInput = row.querySelector('.caller-name');
        const marchInput = row.querySelector('.march-time');

        if (!nameInput || !marchInput) continue;

        const name = nameInput.value.trim();
        const timeStr = marchInput.value.trim();

        if (!name && !timeStr) {
          continue; // ignore empty rows
        }

        if (!timeStr) {
          messageDiv.textContent = 'Each rally needs a march time in seconds.';
          messageDiv.className = 'error';
          return;
        }

        const marchSeconds = parseTime(timeStr);
        if (isNaN(marchSeconds) || marchSeconds <= 0) {
          messageDiv.textContent = `Invalid march time "${timeStr}". Enter march time in seconds only (e.g. 37).`;
          messageDiv.className = 'error';
          return;
        }

        entries.push({
          name: name || 'Unnamed',
          marchSeconds
        });
      }

      if (entries.length < 2) {
        messageDiv.textContent = 'Add at least two rallies to sync.';
        messageDiv.className = 'warn';
        return;
      }

      globalMaxMarch = Math.max(...entries.map(e => e.marchSeconds));
      globalTotalDuration = globalRallySeconds + globalMaxMarch;

      const baseEntries = entries.filter(e => e.marchSeconds === globalMaxMarch);

      let baseLabel;
      if (baseEntries.length === 1) {
        baseLabel = `Base (slowest) rally is <strong>${baseEntries[0].name}</strong> with march <strong>${formatTime(globalMaxMarch)} (${globalMaxMarch.toFixed(0)}s)</strong>.`;
      } else {
        const names = baseEntries.map(e => e.name).join(', ');
        baseLabel = `Multiple rallies share the slowest march time <strong>${formatTime(globalMaxMarch)} (${globalMaxMarch.toFixed(0)}s)</strong>: <strong>${names}</strong>. Choose any one as your base.`;
      }

      const baseTimeStr = baseStartInput.value;
      const baseDate = parseBaseTimeToDate(baseTimeStr);

      if (baseTimeStr && !baseDate) {
        messageDiv.textContent = 'Invalid base rally creation time. Use HH:MM (e.g. 21:05).';
        messageDiv.className = 'error';
        return;
      }

      summaryDiv.innerHTML = `
        <p class="description">
          ${baseLabel}<br>
          Common rally time for all rallies: <strong>${rallyMinutes} min (${formatTime(globalRallySeconds)})</strong>.<br>
          From base rally creation to impact: <strong>${formatTime(globalTotalDuration)} (${globalTotalDuration.toFixed(0)}s)</strong> (rally + base march).<br>
          Click "Start First Rally" when you <strong>create the base rally</strong> in-game (t = 0)${baseDate ? ', or at <strong>' + baseTimeStr + '</strong> real time' : ''}.<br>
          Create each other rally after the listed delay so that <strong>rally time + march time</strong> sync the impact.
        </p>
      `;

      // Build results table and schedule
      entries.forEach(e => {
        const delay = globalMaxMarch - e.marchSeconds;
        const delayClamped = delay < 0 ? 0 : delay;

        const marchStr = `${formatTime(e.marchSeconds)} (${e.marchSeconds.toFixed(0)}s)`;
        const delayStr = `${formatTime(delayClamped)} (${delayClamped.toFixed(0)}s)`;

        const baseTimeStrLocal = baseStartInput.value;
        const baseDateLocal = parseBaseTimeToDate(baseTimeStrLocal);
        let startClockStr = '-';
        if (baseDateLocal) {
          const startDate = new Date(baseDateLocal.getTime() + delayClamped * 1000);
          startClockStr = formatClockTime(startDate);
        }

        const tr = document.createElement('tr');

        const nameTd = document.createElement('td');
        nameTd.textContent = e.name;

        const marchTd = document.createElement('td');
        marchTd.textContent = marchStr;

        const delayTd = document.createElement('td');
        delayTd.textContent = delayStr;

        const startTd = document.createElement('td');
        startTd.textContent = startClockStr;

        tr.appendChild(nameTd);
        tr.appendChild(marchTd);
        tr.appendChild(delayTd);
        tr.appendChild(startTd);

        resultsBody.appendChild(tr);

        schedule.push({
          name: e.name,
          delay: delayClamped,
          rowEl: tr,
          launched: false
        });
      });

      // Sort schedule by delay so we know the order of rally creations
      schedule.sort((a, b) => a.delay - b.delay);

      resultsDiv.style.display = 'block';

      if (schedule.length > 0) {
        liveSection.style.display = 'block';
        liveStatus.textContent = 'Ready. Click "Start First Rally" when the base rally is created.';
        startLiveBtn.disabled = false;
      } else {
        liveSection.style.display = 'none';
      }
    }

    function startLiveCountdown() {
      if (!schedule.length) return;

      resetLive();
      initAudio(); // unlock audio on user gesture
      liveStartTime = Date.now();
      startLiveBtn.disabled = true;
      liveStatus.classList.add('flash');

      liveInterval = setInterval(() => {
        const elapsed = (Date.now() - liveStartTime) / 1000;

        // Beep for any rallies whose delay we just crossed
        for (const item of schedule) {
          if (!item.launched && elapsed >= item.delay) {
            item.launched = true;
            beep();
          }
        }

        const impactRemaining = globalTotalDuration - elapsed;

        // Countdown beeps for last 10 seconds before impact
        if (impactRemaining > 0) {
          const impactSecInt = Math.ceil(impactRemaining);
          if (impactSecInt <= 10 && impactSecInt > 0 && impactSecInt !== lastImpactBeepSecond) {
            beep();
            lastImpactBeepSecond = impactSecInt;
          }
        }

        // If impact reached, stop completely
        if (impactRemaining <= 0) {
          liveStatus.classList.remove('flash');
          liveStatus.innerHTML = 'üéØ Target should be hit now. All synced rallies have landed.';
          schedule.forEach(item => {
            item.rowEl.style.outline = 'none';
          });
          clearInterval(liveInterval);
          liveInterval = null;
          return;
        }

        // Find next upcoming (not yet launched) rally
        let next = null;
        for (const item of schedule) {
          if (!item.launched && item.delay > elapsed) {
            if (!next || item.delay < next.delay) {
              next = item;
            }
          }
        }

        const impactText = `${formatTime(impactRemaining)} (${impactRemaining.toFixed(1)}s)`;

        if (next) {
          const remaining = next.delay - elapsed;

          // Highlight that row
          schedule.forEach(item => {
            item.rowEl.style.outline = 'none';
          });
          next.rowEl.style.outline = '2px solid rgba(250, 204, 21, 0.9)';

          liveStatus.innerHTML = `
            Next rally: <span class="next-name">${next.name}</span>
            in <span class="next-time">${remaining.toFixed(1)}s</span><br>
            Time until impact: <span class="impact-time">${impactText}</span>
          `;
        } else {
          // All rallies created, just show time until impact
          schedule.forEach(item => {
            item.rowEl.style.outline = 'none';
          });
          liveStatus.innerHTML = `
            ‚úÖ All rallies created.<br>
            Time until impact: <span class="impact-time">${impactText}</span>
          `;
        }
      }, 100);
    }

    addRowBtn.addEventListener('click', () => addRow());
    clearBtn.addEventListener('click', () => {
      rallyBody.innerHTML = '';
      resultsDiv.style.display = 'none';
      messageDiv.textContent = '';
      messageDiv.className = '';
      summaryDiv.innerHTML = '';
      baseStartInput.value = '';
      liveSection.style.display = 'none';
      resetLive();
      // add a few blank rows again
      for (let i = 0; i < 3; i++) addRow('Name');
    });
    calcBtn.addEventListener('click', calculate);
    startLiveBtn.addEventListener('click', startLiveCountdown);

    // Start with three default rows
    addRow('Name');
    addRow('Name');
    addRow('Name');
  </script>
</body>
</html>
