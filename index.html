<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kingshot Rally Sync Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #0b1220;
      color: #e5e7eb;
    }

    h1 {
      margin-top: 0;
      font-size: 1.8rem;
      color: #facc15;
      text-align: center;
    }

    .sound-toggle {
      text-align: center;
      margin-bottom: 0.75rem;
      font-size: 0.85rem;
      color: #e5e7eb;
    }

    .sound-toggle label {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .sound-toggle select {
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
    }

    .card {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 20px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .description {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    th, td {
      padding: 0.4rem 0.5rem;
      text-align: left;
      font-size: 0.9rem;
    }

    th {
      border-bottom: 1px solid rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
    }

    tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.6);
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 0.3rem 0.4rem;
      border-radius: 0.4rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #020617;
      color: #e5e7eb;
      box-sizing: border-box;
    }

    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: #facc15;
      box-shadow: 0 0 0 1px #facc15;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
      align-items: center;
      justify-content: space-between;
    }

    .btn-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.4rem 0.9rem;
      font-size: 0.9rem;
      cursor: pointer;
      background: #16a34a;
      color: #f9fafb;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    button.secondary {
      background: #1f2937;
    }

    button.danger {
      background: #b91c1c;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    button:hover:not(:disabled) {
      filter: brightness(1.1);
    }

    .base-time {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .results {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(148, 163, 184, 0.4);
    }

    .results h2 {
      font-size: 1.1rem;
      margin: 0 0 0.4rem;
      color: #e5e7eb;
    }

    .warn {
      color: #f97316;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }

    .error {
      color: #fca5a5;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }

    .tag {
      display: inline-block;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: rgba(34, 197, 94, 0.15);
      color: #bbf7d0;
      border: 1px solid rgba(34, 197, 94, 0.6);
    }

    /* Live countdown section */
    .live {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 0.75rem;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    #liveStatus {
      margin-top: 0.75rem;
      font-size: 1.05rem;
      text-align: center;
      min-height: 3.2rem;
    }

    .next-block {
      text-align: center;
      margin-bottom: 0.5rem;
    }

    .next-label {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .next-name-big {
      font-size: 2.4rem;
      font-weight: 800;
      margin-bottom: 0.15rem;
    }

    .next-time-big {
      font-size: 2.2rem;
      font-weight: 700;
    }

    .impact-line {
      font-size: 1rem;
      margin-top: 0.35rem;
      color: #e5e7eb;
    }

    /* Urgency colours */
    .urgency-low {
      color: #22c55e;
    }
    .urgency-mid {
      color: #f97316;
    }
    .urgency-high {
      color: #ef4444;
    }

    .flash {
      animation: flash 1s infinite;
    }

    @keyframes flash {
      0%, 100% { background-color: transparent; }
      50% { background-color: rgba(250, 204, 21, 0.16); }
    }

    .go-alert {
      background: #dc2626;
      animation: goflash 1s infinite;
    }

    @keyframes goflash {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.05); filter: brightness(1.2); }
    }

    body.live-mode .card > :not(.live) {
      display: none;
    }

    body.live-mode .live {
      margin-top: 0;
    }

    @media (max-width: 600px) {
      body { padding: 0.75rem; }
      .card { padding: 1rem; }
      th, td { font-size: 0.8rem; }
      button { width: 100%; justify-content: center; }
      .btn-row { flex-direction: column; align-items: stretch; }
      .btn-group { width: 100%; flex-direction: column; align-items: flex-start; }
      .btn-group > * { width: 100%; }
      .next-name-big { font-size: 2rem; }
      .next-time-big { font-size: 1.8rem; }
    }
  </style>
</head>
<body>
  <h1>Kingshot Rally Sync Tool</h1>

  <!-- Sound toggle under the title -->
  <div class="sound-toggle">
    <label>
      üîä Sound:
      <select id="soundToggle">
        <option value="on" selected>On</option>
        <option value="off">Off</option>
      </select>
    </label>
  </div>

  <div class="card">
    <p class="description">
      Select a common <strong>rally time</strong> (join window) for all rallies, then enter each rally caller and their
      <strong>march time</strong> to the target.<br>
      Enter march times in <strong>seconds only</strong> (e.g. <code>37</code>).<br>
      The tool syncs hits using <strong>rally time + march time</strong> so all rallies land together.
    </p>

    <div class="btn-row">
      <div class="btn-group">
        <button type="button" id="addRowBtn">Ôºã Add Rally</button>
        <button type="button" class="secondary" id="clearBtn">Clear All</button>
        <button type="button" class="secondary" id="trainingBtn">üß™ KVK Training Mode</button>
      </div>
      <div class="btn-group">
        <label class="base-time">
          Rally time for all rallies:
          <select id="globalRallyTime">
            <option value="1">1 min</option>
            <option value="5">5 min</option>
            <option value="10">10 min</option>
            <option value="30">30 min</option>
            <option value="60">60 min</option>
          </select>
        </label>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width: 12%;">Alliance Tag</th>
          <th style="width: 28%;">Caller Name</th>
          <th style="width: 10%;">Pet</th>
          <th style="width: 30%;">March Time (s)</th>
          <th style="width: 20%;">Delay After Base (s)</th>
        </tr>
      </thead>
      <tbody id="rallyBody">
      </tbody>
    </table>

    <div class="btn-row">
      <button type="button" id="calcBtn">‚öîÔ∏è Calculate Rally Timing</button>
      <span class="base-time">
        Tip: Start a fake rally to test march times from each rally lead to the target, then plug them in here.
      </span>
    </div>

    <div id="message"></div>

    <div class="results" id="results" style="display:none;">
      <h2>Rally Start Schedule <span class="tag">Synced Hit</span></h2>
      <div id="summary"></div>
      <table id="resultsTable">
        <thead>
          <tr>
            <th>Alliance</th>
            <th>Caller</th>
            <th>Pet</th>
            <th>March (s)</th>
            <th>Delay After Base (s)</th>
          </tr>
        </thead>
        <tbody id="resultsBody">
        </tbody>
      </table>
    </div>

    <!-- Live countdown / animation section -->
    <div class="live" id="liveSection" style="display:none;">
      <div class="btn-row" style="margin-bottom:0.5rem;">
        <div class="btn-group">
          <button type="button" id="startLiveBtn">‚ñ∂ Start First Rally</button>
          <button type="button" class="secondary" id="cancelLiveBtn">‚èπ Cancel Rally</button>
          <button type="button" class="secondary" id="editLiveBtn">‚úèÔ∏è Cancel & Edit</button>
        </div>
        <span class="base-time">
          Click <strong>Go</strong> at the exact moment you create the <strong>base rally</strong> with the selected rally time.
        </span>
      </div>
      <div id="goHint" class="base-time" style="text-align:center; margin-bottom:0.5rem;"></div>
      <div id="liveStatus"></div>
    </div>
  </div>

  <!-- Saint Uber footer with insignia -->
  <footer style="
    margin-top: 2rem;
    text-align: center;
    font-size: 0.85rem;
    color: #9ca3af;
    opacity: 0.9;
    padding-bottom: 2rem;
  ">
    <div style="margin-bottom:0.6rem;">
      <svg width="70" height="70" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="gold" x1="0" y1="0" x2="0" y2="200">
            <stop offset="0%" stop-color="#facc15"/>
            <stop offset="100%" stop-color="#b45309"/>
          </linearGradient>
        </defs>

        <!-- Crown -->
        <path d="M50 70 L70 40 L100 75 L130 40 L150 70 L140 120 H60 L50 70Z"
              fill="url(#gold)" stroke="#facc15" stroke-width="4"/>

        <!-- Wings -->
        <path d="M60 120 C20 130 20 170 60 180 L80 160 C40 160 40 135 80 135"
              fill="url(#gold)" stroke="#facc15" stroke-width="3"/>
        <path d="M140 120 C180 130 180 170 140 180 L120 160 C160 160 160 135 120 135"
              fill="url(#gold)" stroke="#facc15" stroke-width="3"/>

        <!-- Central Shield -->
        <circle cx="100" cy="130" r="25"
                fill="url(#gold)" stroke="#facc15" stroke-width="4"/>

        <!-- S symbol -->
        <text x="100" y="138"
              text-anchor="middle"
              font-size="28"
              font-weight="700"
              fill="#0b1220"
              style="font-family: 'Segoe UI', sans-serif;">
          S
        </text>
      </svg>
    </div>

    ‚ú¶ Tool concept by <span style="color:#facc15; font-weight:600;">Saint Uber</span><br>
  </footer>

  <script>
    const rallyBody = document.getElementById('rallyBody');
    const addRowBtn = document.getElementById('addRowBtn');
    const clearBtn = document.getElementById('clearBtn');
    const trainingBtn = document.getElementById('trainingBtn');
    const calcBtn = document.getElementById('calcBtn');
    const messageDiv = document.getElementById('message');
    const resultsDiv = document.getElementById('results');
    const resultsBody = document.getElementById('resultsBody');
    const summaryDiv = document.getElementById('summary');
    const globalRallyTimeSelect = document.getElementById('globalRallyTime');

    const liveSection = document.getElementById('liveSection');
    const liveStatus = document.getElementById('liveStatus');
    const startLiveBtn = document.getElementById('startLiveBtn');
    const cancelLiveBtn = document.getElementById('cancelLiveBtn');
    const editLiveBtn = document.getElementById('editLiveBtn');
    const goHint = document.getElementById('goHint');

    const soundToggle = document.getElementById('soundToggle');

    // Sound enabled flag
    let soundEnabled = true;

    // Live countdown
    let schedule = [];          // [{ tag, name, petBuff, label, hudLabel, delay, rowEl, launched, lastCallSecond }]
    let liveInterval = null;
    let liveStartTime = null;

    // Rally timing globals
    let globalRallySeconds = 5 * 60;
    let globalMaxMarch = 0;
    let globalTotalDuration = 0;  // rally time + max march
    let lastImpactBeepSecond = null;

    // Voice state
    let marchVoiceAnnounced = false;
    let hypeSpoken = false;
    let lastCountdownSpoken = null;

    // Audio beep
    let audioCtx = null;

    soundToggle.addEventListener('change', (e) => {
      soundEnabled = (e.target.value === 'on');
    });

    function initAudio() {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (AC) audioCtx = new AC();
      }
      if (audioCtx && audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    }

    function beep() {
      if (!soundEnabled) return;
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 880;
      gain.gain.value = 0.12;
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      osc.start(now);
      osc.stop(now + 0.15);
    }

    function speak(text) {
      if (!soundEnabled) return;
      if (!('speechSynthesis' in window)) return;

      // Strip paw emoji and brackets from spoken text: "[Ksa] Saint" -> "Ksa Saint"
      let clean = text.replace(/üêæ/g, '');
      clean = clean.replace(/\[([^\]]+)\]\s*/g, '$1 ');
      clean = clean.replace(/\s+/g, ' ').trim();
      if (!clean) return;

      const u = new SpeechSynthesisUtterance(clean);
      window.speechSynthesis.speak(u);
    }

    function makeLabel(tag, name) {
      tag = (tag || '').trim();
      name = (name || '').trim();
      if (tag && name) return `[${tag}] ${name}`;
      if (name) return name;
      if (tag) return `[${tag}]`;
      return 'Unnamed';
    }

    function makeHudLabel(label, petBuff) {
      return petBuff ? `üêæ ${label}` : label;
    }

    function addRow(tag = '', name = '', marchTime = '', petBuff = false) {
      const tr = document.createElement('tr');

      // Alliance tag
      const tagTd = document.createElement('td');
      const tagInput = document.createElement('input');
      tagInput.type = 'text';
      tagInput.placeholder = 'Tag';
      if (tag) tagInput.value = tag;
      tagInput.classList.add('caller-tag');
      tagTd.appendChild(tagInput);

      // Caller name
      const nameTd = document.createElement('td');
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.placeholder = 'Name';
      if (name) nameInput.value = name;
      nameInput.classList.add('caller-name');
      nameTd.appendChild(nameInput);

      // Pet buff checkbox
      const petTd = document.createElement('td');
      const petInput = document.createElement('input');
      petInput.type = 'checkbox';
      petInput.classList.add('pet-buff');
      petInput.title = 'Pet buff active';
      petInput.checked = !!petBuff;
      petTd.style.textAlign = 'center';
      petTd.appendChild(petInput);

      // March time in seconds
      const timeTd = document.createElement('td');
      const timeInput = document.createElement('input');
      timeInput.type = 'text';
      timeInput.placeholder = 'seconds (e.g. 37)';
      if (marchTime) timeInput.value = marchTime;
      timeInput.classList.add('march-time');
      timeTd.appendChild(timeInput);

      // Delay After Base (s) - filled after calculation
      const delayTd = document.createElement('td');
      delayTd.textContent = '-';

      tr.appendChild(tagTd);
      tr.appendChild(nameTd);
      tr.appendChild(petTd);
      tr.appendChild(timeTd);
      tr.appendChild(delayTd);

      rallyBody.appendChild(tr);
    }

    // Parse seconds-only
    function parseTime(str) {
      if (!str) return NaN;
      str = str.trim();
      const v = parseFloat(str);
      return isNaN(v) || v <= 0 ? NaN : v;
    }

    // For summary text only
    function formatTime(sec) {
      if (!isFinite(sec)) return '';
      sec = Math.round(sec);
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return m + ':' + String(s).padStart(2, '0');
    }

    function resetLiveState(fullReset = false) {
      if (liveInterval) {
        clearInterval(liveInterval);
        liveInterval = null;
      }
      liveStartTime = null;
      liveStatus.textContent = '';
      liveStatus.classList.remove('flash');
      lastImpactBeepSecond = null;
      marchVoiceAnnounced = false;
      hypeSpoken = false;
      lastCountdownSpoken = null;
      schedule.forEach(item => {
        item.rowEl.style.outline = 'none';
        item.lastCallSecond = null;
      });
      startLiveBtn.disabled = false;
      if (fullReset) {
        startLiveBtn.textContent = '‚ñ∂ Start First Rally';
        startLiveBtn.classList.remove('go-alert');
        goHint.textContent = '';
        document.body.classList.remove('live-mode');
      }
    }

    function calculate() {
      messageDiv.innerHTML = '';
      messageDiv.className = '';
      resultsDiv.style.display = 'none';
      resultsBody.innerHTML = '';
      summaryDiv.innerHTML = '';
      liveSection.style.display = 'none';
      resetLiveState(true);
      schedule = [];

      const rallyMinutes = parseInt(globalRallyTimeSelect.value, 10) || 5;
      globalRallySeconds = rallyMinutes * 60;

      const rows = Array.from(rallyBody.querySelectorAll('tr'));
      const entries = [];

      for (const row of rows) {
        const tagInput = row.querySelector('.caller-tag');
        const nameInput = row.querySelector('.caller-name');
        const petInput = row.querySelector('.pet-buff');
        const marchInput = row.querySelector('.march-time');

        if (!nameInput || !marchInput || !tagInput || !petInput) continue;

        const tag = tagInput.value.trim();
        const name = nameInput.value.trim();
        const timeStr = marchInput.value.trim();
        const petBuff = !!petInput.checked;

        if (!tag && !name && !timeStr && !petBuff) {
          continue; // ignore empty row
        }

        if (!timeStr) {
          messageDiv.textContent = 'Each rally needs a march time in seconds.';
          messageDiv.className = 'error';
          return;
        }

        const secs = parseTime(timeStr);
        if (isNaN(secs)) {
          messageDiv.textContent = `Invalid march time "${timeStr}". Enter seconds only (e.g. 37).`;
          messageDiv.className = 'error';
          return;
        }

        entries.push({
          tag,
          name: name || 'Unnamed',
          petBuff,
          marchSeconds: secs,
          rowEl: row
        });
      }

      if (entries.length < 2) {
        messageDiv.textContent = 'Add at least two rallies to sync.';
        messageDiv.className = 'warn';
        return;
      }

      globalMaxMarch = Math.max(...entries.map(e => e.marchSeconds));
      globalTotalDuration = globalRallySeconds + globalMaxMarch;

      const baseEntries = entries.filter(e => e.marchSeconds === globalMaxMarch);

      let baseLabel;
      if (baseEntries.length === 1) {
        const be = baseEntries[0];
        const label = makeLabel(be.tag, be.name);
        const hudLabel = makeHudLabel(label, be.petBuff);
        baseLabel = `Base (slowest) rally is <strong>${hudLabel}</strong> with march <strong>${globalMaxMarch}s (${formatTime(globalMaxMarch)})</strong>.`;
      } else {
        const labels = baseEntries
          .map(e => makeHudLabel(makeLabel(e.tag, e.name), e.petBuff))
          .join(', ');
        baseLabel = `Multiple base rallies share the slowest march time <strong>${globalMaxMarch}s (${formatTime(globalMaxMarch)})</strong>: <strong>${labels}</strong>. Choose any one as your base.`;
      }

      // Update Go button + hint
      if (baseEntries.length === 1) {
        const be = baseEntries[0];
        const label = makeLabel(be.tag, be.name);
        const hudLabel = makeHudLabel(label, be.petBuff);
        startLiveBtn.textContent = `‚ñ∂ Go ${hudLabel}`;
        startLiveBtn.classList.add('go-alert');
        goHint.textContent = `${hudLabel} must launch first to sync all rallies.`;
      } else {
        startLiveBtn.textContent = '‚ñ∂ Go Base Rally';
        startLiveBtn.classList.add('go-alert');
        const labels = baseEntries
          .map(e => makeHudLabel(makeLabel(e.tag, e.name), e.petBuff))
          .join(', ');
        goHint.textContent = `Any base rally (slowest march: ${labels}) can launch first to sync all rallies.`;
      }

      summaryDiv.innerHTML = `
        <p class="description">
          ${baseLabel}<br>
          Common rally time: <strong>${rallyMinutes} min (${globalRallySeconds}s, ${formatTime(globalRallySeconds)})</strong>.<br>
          From base rally creation (t = 0) to impact: <strong>${globalTotalDuration}s (${formatTime(globalTotalDuration)})</strong>.<br>
          Click "Go" when the base rally is created in-game. Launch all other rallies after the listed delays.
        </p>
      `;

      // Build results table & schedule (seconds-only), and update top-table delay cells
      entries.forEach(e => {
        const delay = Math.max(0, globalMaxMarch - e.marchSeconds);
        const label = makeLabel(e.tag, e.name);
        const hudLabel = makeHudLabel(label, e.petBuff);

        // Update delay cell in the TOP table (input rows)
        const originalDelayCell = e.rowEl.children[4]; // 5th <td>
        if (originalDelayCell) {
          originalDelayCell.textContent = `${delay}s`;
        }

        // Fill the RESULTS table below
        const tr = document.createElement('tr');

        const tagTd = document.createElement('td');
        tagTd.textContent = e.tag || '';

        const nameTd = document.createElement('td');
        nameTd.textContent = e.name;

        const petTd = document.createElement('td');
        petTd.textContent = e.petBuff ? 'üêæ' : '';

        const marchTd = document.createElement('td');
        marchTd.textContent = `${e.marchSeconds}s`;

        const delayTd = document.createElement('td');
        delayTd.textContent = `${delay}s`;

        tr.appendChild(tagTd);
        tr.appendChild(nameTd);
        tr.appendChild(petTd);
        tr.appendChild(marchTd);
        tr.appendChild(delayTd);
        resultsBody.appendChild(tr);

        schedule.push({
          tag: e.tag,
          name: e.name,
          petBuff: e.petBuff,
          label,
          hudLabel,
          delay,
          rowEl: tr,
          launched: false,
          lastCallSecond: null
        });
      });

      // Sort schedule by delay so we know call order
      schedule.sort((a, b) => a.delay - b.delay);

      resultsDiv.style.display = 'block';
      liveSection.style.display = 'block';
      liveStatus.textContent = 'Ready. Click the Go button when the base rally is created.';
      startLiveBtn.disabled = false;

      // Enter focused HUD mode as soon as we calculate
      document.body.classList.add('live-mode');
    }

    function runLiveLoop() {
      if (liveInterval) {
        clearInterval(liveInterval);
        liveInterval = null;
      }

      liveInterval = setInterval(() => {
        const elapsed = (Date.now() - liveStartTime) / 1000;
        const impactRemaining = globalTotalDuration - elapsed;

        // Announce when the marches actually start (rally timer finished)
        if (!marchVoiceAnnounced && elapsed >= globalRallySeconds) {
          speak('Marching now!');
          marchVoiceAnnounced = true;
        }

        // Per-rally countdowns + Go
        for (const item of schedule) {
          if (item.launched) continue;

          const remainingDelay = item.delay - elapsed;

          if (remainingDelay > 0 && remainingDelay <= 5) {
            const sec = Math.ceil(remainingDelay);
            if (sec !== item.lastCallSecond) {
              // "[Tag] Name in 5, 4, 3, 2, 1"
              beep();
              if (sec === 5) {
                speak(`${item.label} in 5`);
              } else {
                speak(String(sec));
              }
              item.lastCallSecond = sec;
            }
          } else if (remainingDelay <= 0) {
            // Go!
            item.launched = true;
            beep();
            speak(`Go ${item.label}`);
            if (navigator.vibrate) {
              navigator.vibrate([150, 80, 150]);
            }
          }
        }

        // Impact reached
        if (impactRemaining <= 0) {
          liveStatus.classList.remove('flash');
          liveStatus.innerHTML = `
            <div class="next-block">
              <div class="next-label">Impact</div>
              <div class="next-name-big urgency-high">Target Hit</div>
            </div>
          `;
          schedule.forEach(item => {
            item.rowEl.style.outline = 'none';
          });
          clearInterval(liveInterval);
          liveInterval = null;
          document.body.classList.remove('live-mode'); // exit HUD mode
          return;
        }

        // Last 10 seconds countdown beeps (to impact) + hype + 5‚Äì1 countdown
        const impactSecInt = Math.ceil(impactRemaining);
        if (impactSecInt <= 10 && impactSecInt > 0) {
          if (impactSecInt !== lastImpactBeepSecond) {
            beep();
            lastImpactBeepSecond = impactSecInt;

            // 10 seconds: random hype line
            if (impactSecInt === 10 && !hypeSpoken) {
              const lines = [
                "Let's go!",
                "Come on!",
                "HONK!",
                "Give me bread!"
              ];
              const line = lines[Math.floor(Math.random() * lines.length)];
              speak(line);
              hypeSpoken = true;
            }

            // 5‚Äì1 seconds: numeric countdown
            if (impactSecInt <= 5 && impactSecInt >= 1 && lastCountdownSpoken !== impactSecInt) {
              speak(String(impactSecInt));
              lastCountdownSpoken = impactSecInt;
            }
          }
        }

        // Find next rally to launch (not yet launched and still ahead)
        let next = null;
        for (const item of schedule) {
          const remainingDelay = item.delay - elapsed;
          if (!item.launched && remainingDelay > 0) {
            if (!next || remainingDelay < (next.delay - elapsed)) {
              next = item;
            }
          }
        }

        if (next) {
          const remaining = next.delay - elapsed;

          // Urgency colour
          let urgencyClass = 'urgency-low';
          if (remaining <= 1) {
            urgencyClass = 'urgency-high';
          } else if (remaining <= 3) {
            urgencyClass = 'urgency-mid';
          }

          schedule.forEach(item => item.rowEl.style.outline = 'none');
          next.rowEl.style.outline = '2px solid rgba(250, 204, 21, 0.9)';

          let mainLine;
          if (remaining <= 5) {
            // Show "[Tag] Saint in 5s" style
            const sec = Math.ceil(remaining);
            mainLine = `
              <div class="next-name-big ${urgencyClass}">${next.hudLabel}</div>
              <div class="next-time-big ${urgencyClass}">in ${sec}s</div>
            `;
          } else {
            // Normal numeric countdown
            mainLine = `
              <div class="next-name-big ${urgencyClass}">${next.hudLabel}</div>
              <div class="next-time-big ${urgencyClass}">${remaining.toFixed(1)}s</div>
            `;
          }

          liveStatus.innerHTML = `
            <div class="next-block">
              <div class="next-label">Next rally</div>
              ${mainLine}
            </div>
            <div class="impact-line">
              Impact in <span class="impact-time">${impactRemaining.toFixed(1)}s</span>
            </div>
          `;
        } else {
          // All rallies created
          schedule.forEach(item => item.rowEl.style.outline = 'none');

          if (elapsed < globalRallySeconds) {
            // Still in rally timer: WAITING for marches to start
            const waitRemaining = globalRallySeconds - elapsed;
            liveStatus.innerHTML = `
              <div class="next-block">
                <div class="next-label">All rallies created</div>
                <div class="next-name-big urgency-low">Waiting</div>
              </div>
              <div class="impact-line">
                March starts in <span class="impact-time">${waitRemaining.toFixed(1)}s</span><br>
                Impact in <span class="impact-time">${impactRemaining.toFixed(1)}s</span>
              </div>
            `;
          } else {
            // Rally timer finished: marches are moving
            liveStatus.innerHTML = `
              <div class="next-block">
                <div class="next-label">All rallies created</div>
                <div class="next-name-big urgency-low">Marching</div>
              </div>
              <div class="impact-line">
                Impact in <span class="impact-time">${impactRemaining.toFixed(1)}s</span>
              </div>
            `;
          }
        }
      }, 100);
    }

    function startLiveCountdown() {
      if (!schedule.length) return;

      initAudio();
      resetLiveState(false); // clear any previous loop but keep HUD + labels
      document.body.classList.add('live-mode');

      liveStartTime = Date.now();
      startLiveBtn.disabled = true;
      startLiveBtn.classList.remove('go-alert');
      liveStatus.classList.add('flash');

      schedule.forEach(item => {
        item.launched = false;
        item.lastCallSecond = null;
      });

      runLiveLoop();
    }

    function cancelLive() {
      // Stop timers, stay in HUD, keep schedule & labels so user can hit Go again
      resetLiveState(false);
      liveSection.style.display = 'block';
      document.body.classList.add('live-mode');
      liveStatus.innerHTML = `
        <div class="next-block">
          <div class="next-label">Rally cancelled</div>
          <div class="next-name-big urgency-low">Ready</div>
        </div>
        <div class="impact-line">
          Press <span class="impact-time">Start First Rally</span> to run again.
        </div>
      `;
    }

    function cancelAndEdit() {
      // Stop timers, exit HUD, hide schedule, go back to edit view
      resetLiveState(true);
      resultsDiv.style.display = 'none';
      summaryDiv.innerHTML = '';
      liveSection.style.display = 'block';
      document.body.classList.remove('live-mode');
    }

    function loadTrainingScenario() {
      // Quick KVK practice: prefill some example callers + times and auto-calc
      resetLiveState(true);
      messageDiv.textContent = '';
      messageDiv.className = '';
      resultsDiv.style.display = 'none';
      resultsBody.innerHTML = '';
      summaryDiv.innerHTML = '';
      liveSection.style.display = 'none';

      // Use 1-minute rally for short training runs
      globalRallyTimeSelect.value = '1';

      // Clear existing rows and load a sample scenario
      rallyBody.innerHTML = '';

      addRow('Ksa', 'Saul', '40', true);
      addRow('Ksa', 'Amadeus', '47', false);
      addRow('Ksa', 'Jabel', '53', true);
      addRow('Ksa', 'Helga', '60', false);
      addRow('Ksa', 'Chenko', '68', true);

      // Auto-run calculation and jump into HUD mode
      calculate();
    }

    // Event hooks
    addRowBtn.addEventListener('click', () => addRow());
    clearBtn.addEventListener('click', () => {
      rallyBody.innerHTML = '';
      resultsDiv.style.display = 'none';
      summaryDiv.innerHTML = '';
      liveSection.style.display = 'none';
      messageDiv.textContent = '';
      messageDiv.className = '';
      resetLiveState(true);
      schedule = [];
      addRow();
      addRow();
      addRow();
    });
    trainingBtn.addEventListener('click', loadTrainingScenario);
    calcBtn.addEventListener('click', calculate);
    startLiveBtn.addEventListener('click', startLiveCountdown);
    cancelLiveBtn.addEventListener('click', cancelLive);
    editLiveBtn.addEventListener('click', cancelAndEdit);

    // Default empty rows on load
    addRow();
    addRow();
    addRow();
  </script>
</body>
</html>
